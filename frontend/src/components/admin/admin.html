<!-- 🔐 PANTALLA DE LOGIN -->
<div *ngIf="!isLoggedIn" class="login-container">
  <div class="login-card">
    <div class="login-header">
      <span class="emoji">🛡️</span>
      <h2>Panel de Administración</h2>
      <p>Solo administradores con @onichip.com</p>
    </div>

    <form [formGroup]="loginForm" (ngSubmit)="login()">
      <div class="form-group">
        <label>Email de administrador</label>
        <input type="email" formControlName="email" placeholder="admin@onichip.com">
      </div>

      <div class="form-group">
        <label>Contraseña</label>
        <input type="password" formControlName="password" placeholder="••••••">
      </div>

      <div *ngIf="loginError" class="error-msg">{{ loginError }}</div>

      <button type="submit" [disabled]="loading" class="login-btn">
        <span *ngIf="!loading">🔓</span>
        {{ loading ? 'Verificando...' : 'Acceder al Panel' }}
      </button>
    </form>
  </div>
</div>

<!-- 🎛️ PANEL PRINCIPAL DE ADMINISTRACIÓN -->
<div *ngIf="isLoggedIn" class="admin-panel">
  <!-- Header del admin -->
  <header class="admin-header">
    <div class="header-left">
      <span class="emoji">🛡️</span>
      <h1>Panel de Administración</h1>
    </div>
    <div class="header-right">
      <span class="admin-info">
        <span class="emoji">👨‍💼</span>
        {{ adminData?.nombre }} (Admin)
      </span>
      <button (click)="logout()" class="logout-btn">
        <span class="emoji">🚪</span> Cerrar Sesión
      </button>
    </div>
  </header>

  <!-- Navegación por pestañas -->
  <nav class="admin-nav">
    <button
      [class.active]="activeTab === 'dashboard'"
      (click)="setActiveTab('dashboard')"
      class="nav-btn">
      <span class="emoji">📊</span> Dashboard
    </button>
    <button
      [class.active]="activeTab === 'usuarios'"
      (click)="setActiveTab('usuarios')"
      class="nav-btn">
      <span class="emoji">👥</span> Usuarios
    </button>
    <button
      [class.active]="activeTab === 'mascotas'"
      (click)="setActiveTab('mascotas')"
      class="nav-btn">
      <span class="emoji">🐕</span> Mascotas
    </button>
    <button
      [class.active]="activeTab === 'reportes'"
      (click)="setActiveTab('reportes')"
      class="nav-btn">
      <span class="emoji">📋</span> Reportes
    </button>
    <button
      [class.active]="activeTab === 'alertas'"
      (click)="setActiveTab('alertas')"
      class="nav-btn">
      <span class="emoji">🚨</span> Alertas
    </button>
  </nav>

  <!-- Contenido principal -->
  <main class="admin-content">

    <!-- 📊 DASHBOARD COMPLETO -->
    <div *ngIf="activeTab === 'dashboard'" class="dashboard-tab">
      <!-- Header del dashboard con botón de actualizar -->
      <div class="dashboard-header">
        <div class="dashboard-title">
          <h2><span class="emoji">📊</span> Dashboard Ejecutivo</h2>
          <p>Monitoreo en tiempo real del sistema IoT</p>
        </div>
        <button (click)="loadDashboardData()" class="refresh-btn-small" [disabled]="loadingStats" title="Actualizar datos">
          <span class="emoji">{{ loadingStats ? '⏳' : '🔄' }}</span>
        </button>
      </div>

      <!-- Estadísticas rápidas -->
      <div class="stats-grid">
        <div class="stat-card primary">
          <span class="emoji">👥</span>
          <div class="stat-info">
            <h3>{{ getTotalUsuarios() }}</h3>
            <p>Total Usuarios</p>
            <small>+{{ getNuevosUsuarios30d() }} este mes</small>
          </div>
        </div>

        <div class="stat-card success">
          <span class="emoji">🐕</span>
          <div class="stat-info">
            <h3>{{ getTotalMascotas() }}</h3>
            <p>Total Mascotas</p>
            <small>+{{ getNuevasMascotas30d() }} este mes</small>
          </div>
        </div>

        <div class="stat-card warning">
          <span class="emoji">📈</span>
          <div class="stat-info">
            <h3>{{ getCrecimientoUsuarios() }}%</h3>
            <p>Crecimiento</p>
            <small>Últimos 30 días</small>
          </div>
        </div>

        <div class="stat-card info">
          <span class="emoji">🎯</span>
          <div class="stat-info">
            <h3>{{ getPromedioMascotasPorUsuario() }}</h3>
            <p>Mascotas/Usuario</p>
            <small>Promedio</small>
          </div>
        </div>
      </div>

      <!-- Métricas del sistema -->
      <div class="system-metrics">
        <h3><span class="emoji">⚡</span> Rendimiento del Sistema</h3>
        <div class="metrics-grid">
          <div class="metric-card">
            <span class="emoji">📊</span>
            <div class="metric-info">
              <h4>{{ getDispositivosActivos() }}</h4>
              <p>Dispositivos Activos</p>
              <small>En tiempo real</small>
            </div>
          </div>
          <div class="metric-card">
            <span class="emoji">📋</span>
            <div class="metric-info">
              <h4>{{ auditLogs.length }}</h4>
              <p>Eventos Totales</p>
              <small>Auditoría del sistema</small>
            </div>
          </div>
          <div class="metric-card">
            <span class="emoji">👨‍💻</span>
            <div class="metric-info">
              <h4>{{ getUsuariosActivos() }}</h4>
              <p>Usuarios Activos</p>
              <small>Este mes</small>
            </div>
          </div>
        </div>
      </div>

      <!-- Dashboard con Gráficos Estadísticos -->
      <div class="dashboard-charts-section">
        <h3><span class="emoji">📈</span> Análisis Estadístico</h3>
        <div class="charts-grid">
          <!-- Gráfico de Pastel -->
          <div class="chart-container">
            <h4>Distribución de Mascotas por Tipo</h4>
            <canvas #pieChart class="chart-canvas"></canvas>
          </div>

          <!-- Gráfico de Barras -->
          <div class="chart-container">
            <h4>Usuarios Activos por Horario</h4>
            <canvas #barChart class="chart-canvas"></canvas>
          </div>

          <!-- Gráfico de Líneas -->
          <div class="chart-container">
            <h4>Actividad Mensual de Dispositivos</h4>
            <canvas #lineChart class="chart-canvas"></canvas>
          </div>
        </div>
      </div>

      <!-- Eventos recientes del sistema - MOVIDO AL FINAL -->
      <div class="alerts-section">
        <h3><span class="emoji">📋</span> Eventos Recientes del Sistema</h3>
        <div class="alerts-grid">
          <div *ngFor="let log of auditLogs.slice(0, 5)" class="alert alert-info">
            <span class="emoji">📝</span>
            <div class="alert-content">
              <h4>{{ log.accion }}</h4>
              <p>{{ log.actor_tipo }}: {{ log.actor_id }} - {{ log.fecha_hora | date:'short' }}</p>
            </div>
          </div>
          <div *ngIf="auditLogs.length === 0" class="alert alert-success">
            <span class="emoji">✅</span>
            <div class="alert-content">
              <h4>Sistema en calma</h4>
              <p>No hay eventos recientes registrados</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 👥 GESTIÓN DE USUARIOS -->
    <div *ngIf="activeTab === 'usuarios'" class="usuarios-tab">
      <div class="tab-header">
        <h2><span class="emoji">👥</span> Gestión de Usuarios</h2>
        <div class="tab-actions">
          <div class="search-box">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (keyup.enter)="onSearch()"
              placeholder="Buscar por nombre o email...">
            <button (click)="onSearch()">🔍</button>
          </div>
          <button (click)="openUsuarioModal()" class="primary-btn">
            <span class="emoji">➕</span> Nuevo Usuario
          </button>
        </div>
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Usuario</th>
              <th>Email</th>
              <th>Mascotas</th>
              <th>Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let usuario of usuarios">
              <td>
                <span
                  class="id-badge"
                  [title]="'ID completo: ' + usuario._id">
                  {{ getShortId(usuario._id) }}
                </span>
              </td>
              <td>
                <div class="user-info">
                  <span class="emoji">👤</span>
                  <strong>{{ usuario.nombre }}</strong>
                </div>
              </td>
              <td>{{ usuario.email }}</td>
              <td>
                <span class="badge">{{ usuario.cantidadMascotas || 0 }}</span>
              </td>
              <td>{{ formatDate(usuario.createdAt || usuario.fechaRegistro) }}</td>
              <td>
                <div class="action-buttons">
                  <button (click)="openUsuarioModal(usuario)" class="edit-btn">✏️</button>
                  <button (click)="deleteUsuario(usuario._id)" class="delete-btn">🗑️</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <button (click)="prevPage()" [disabled]="usuariosPage <= 1">← Anterior</button>
        <span>Página {{ usuariosPage }}</span>
        <button (click)="nextPage()">Siguiente →</button>
      </div>
    </div>

    <!-- 🐕 GESTIÓN DE MASCOTAS -->
    <div *ngIf="activeTab === 'mascotas'" class="mascotas-tab">
      <div class="tab-header">
        <h2><span class="emoji">🐕</span> Gestión de Mascotas</h2>
        <div class="tab-actions">
          <div class="search-box">
            <input
              type="text"
              [(ngModel)]="searchTerm"
              (keyup.enter)="onSearch()"
              placeholder="Buscar por nombre o especie...">
            <button (click)="onSearch()">🔍</button>
          </div>
          <button (click)="openMascotaModal()" class="primary-btn">
            <span class="emoji">➕</span> Nueva Mascota
          </button>
        </div>
      </div>

      <div class="table-container">
        <table class="data-table">
          <thead>
            <tr>
              <th>ID</th>
              <th>Mascota</th>
              <th>Especie</th>
              <th>Raza</th>
              <th>Edad</th>
              <th>Propietario</th>
              <th>Registro</th>
              <th>Acciones</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let mascota of mascotas">
              <td>
                <span
                  class="id-badge"
                  [title]="'ID completo: ' + mascota._id">
                  {{ getShortId(mascota._id) }}
                </span>
              </td>
              <td>
                <div class="pet-info">
                  <span class="emoji">{{ mascota.especie === 'Perro' ? '🐕' : '🐱' }}</span>
                  <strong>{{ mascota.nombre }}</strong>
                </div>
              </td>
              <td>{{ mascota.especie }}</td>
              <td>{{ mascota.raza }}</td>
              <td>{{ mascota.edad }} años</td>
              <td>{{ getPropietarioNombre(mascota.propietario) }}</td>
              <td>{{ formatDate(mascota.createdAt) }}</td>
              <td>
                <div class="action-buttons">
                  <button (click)="openMascotaModal(mascota)" class="edit-btn">✏️</button>
                  <button (click)="deleteMascota(mascota._id)" class="delete-btn">🗑️</button>
                </div>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="pagination">
        <button (click)="prevPage()" [disabled]="mascotasPage <= 1">← Anterior</button>
        <span>Página {{ mascotasPage }}</span>
        <button (click)="nextPage()">Siguiente →</button>
      </div>
    </div>

    <!-- 🚨 ALERTAS CRÍTICAS -->
    <div *ngIf="activeTab === 'alertas'" class="alertas-tab">
      <div class="tab-header">
        <h2><span class="emoji">🚨</span> Centro de Auditoría del Sistema</h2>
        <div class="tab-actions">
          <button (click)="loadAuditLogs()" class="refresh-btn" [disabled]="loading">
            <span class="emoji">🔄</span>
            {{ loading ? 'Actualizando...' : 'Actualizar' }}
          </button>
        </div>
      </div>

      <div class="alerts-summary">
        <div class="summary-grid">
          <div class="summary-card info">
            <span class="emoji">�</span>
            <div class="summary-info">
              <h3>{{ auditLogs.length }}</h3>
              <p>Total Eventos</p>
            </div>
          </div>
          <div class="summary-card success">
            <span class="emoji">✅</span>
            <div class="summary-info">
              <h3>{{ getTotalEventosExitosos() }}</h3>
              <p>Eventos Exitosos</p>
            </div>
          </div>
          <div class="summary-card warning">
            <span class="emoji">⚠️</span>
            <div class="summary-info">
              <h3>{{ getTotalEventosAdvertencia() }}</h3>
              <p>Advertencias</p>
            </div>
          </div>
          <div class="summary-card error">
            <span class="emoji">❌</span>
            <div class="summary-info">
              <h3>{{ getTotalEventosError() }}</h3>
              <p>Errores</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Lista de eventos de auditoría -->
      <div class="alerts-list">
        <div *ngIf="auditLogs.length === 0" class="no-data">
          <span class="emoji">📭</span>
          <p>No hay eventos de auditoría disponibles</p>
        </div>

        <div *ngFor="let log of auditLogs" class="alert-item">
          <div class="alert-icon">
            <span class="emoji">📝</span>
          </div>
          <div class="alert-content">
            <div class="alert-header">
              <h4 class="alert-title">{{ log.accion }}</h4>
              <span class="alert-timestamp">{{ log.fecha_hora | date:'short' }}</span>
            </div>
            <div class="alert-details">
              <p><strong>Actor:</strong> {{ log.actor_tipo }} - {{ log.actor_id }}</p>
              <p><strong>Entidad:</strong> {{ log.entidad_tipo }} (ID: {{ log.entidad_id }})</p>
              <div *ngIf="log.detalles" class="alert-extra">
                <strong>Detalles:</strong> {{ log.detalles }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- 📋 SECCIÓN DE REPORTES -->
<div *ngIf="activeTab === 'reportes'" id="reportes" class="reportes-tab">
  <div class="reportes-container">
    <div class="reportes-header">
      <h2><span class="emoji">📋</span> Sistema de Reportes</h2>
      <p>Genere reportes basados en auditoría y datos del sistema</p>
    </div>

    <!-- Generador de Reportes -->
    <div class="report-generator">
      <h3>🔧 Generador de Reportes</h3>
      <form (ngSubmit)="generateReport()">
        <div class="filters-grid">
          <div class="form-group">
            <label>Tipo de Reporte</label>
            <select [(ngModel)]="reporteFilters.tipoReporte" name="tipoReporte">
              <option *ngFor="let tipo of tiposReporteFuncionales" [value]="tipo.value">
                {{ tipo.label }}
              </option>
            </select>
            <small class="form-help">{{ getDescripcionTipoReporte(reporteFilters.tipoReporte) }}</small>
          </div>

          <div class="form-group">
            <label>Fecha Inicio</label>
            <input type="date" [(ngModel)]="reporteFilters.fechaInicio" name="fechaInicio">
          </div>

          <div class="form-group">
            <label>Fecha Fin</label>
            <input type="date" [(ngModel)]="reporteFilters.fechaFin" name="fechaFin">
          </div>

          <!-- Búsqueda de Usuario para reporte personalizado -->
        </div>

        <div class="filter-actions">
          <button type="submit" class="primary-btn" [disabled]="generatingReport">
            <span *ngIf="!generatingReport">📊</span>
            <span *ngIf="generatingReport">⏳</span>
            {{ generatingReport ? 'Generando...' : 'Generar Reporte' }}
          </button>

          <button type="button"
                  (click)="exportToExcel()"
                  class="export-button secondary-btn"
                  [disabled]="reporteData.total === 0 || loading">
            📄 Exportar a Excel
          </button>

          <button type="button"
                  (click)="exportToPDF()"
                  class="export-button secondary-btn"
                  [disabled]="reporteData.total === 0 || loading">
            📋 Exportar a PDF
          </button>
        </div>

        <!-- Barra de progreso de generación -->
        <div *ngIf="generatingReport" class="progress-section">
          <div class="progress-header">
            <h4>Generando Reporte...</h4>
            <span class="progress-percentage">{{ reportProgress }}%</span>
          </div>
          <div class="progress-bar">
            <div class="progress-fill" [style.width.%]="reportProgress"></div>
          </div>
          <p class="progress-status">{{ currentOperation }}</p>
        </div>
      </form>
    </div>

    <!-- Vista Previa de Datos -->
    <div *ngIf="reporteData?.total && reporteData.total > 0" class="data-preview">
      <div class="preview-header">
        <h4>Vista Previa del Reporte: {{ reporteFilters.tipoReporte }}</h4>
        <div class="preview-info">
          <span class="info-badge">
            <span class="emoji">📅</span>
            Período: {{ reporteFilters.fechaInicio ? (reporteFilters.fechaInicio | date:'dd/MM/yyyy') : 'Sin filtro' }}
            - {{ reporteFilters.fechaFin ? (reporteFilters.fechaFin | date:'dd/MM/yyyy') : 'Sin filtro' }}
          </span>
          <span class="info-badge">
            <span class="emoji">📊</span>
            Total: {{ reporteData.total }} registros
          </span>
        </div>
      </div>

      <!-- Tabla de datos -->
      <div class="table-content">
        <table class="preview-table">
          <thead>
            <tr>
              <th *ngFor="let key of getPreviewHeaders()">{{ key | titlecase }}</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of getReporteDataSlice(10)">
              <td *ngFor="let key of getPreviewHeaders()">{{ item[key] }}</td>
            </tr>
          </tbody>
        </table>
      </div>

      <div class="preview-footer">
        <div *ngIf="reporteData.total > 10" class="pagination-info">
          <span class="emoji">📄</span>
          Mostrando 10 de {{ reporteData.total }} registros.
          Use la exportación para ver todos los datos.
        </div>
        <div class="export-reminder">
          <span class="emoji">💡</span>
          Los botones de exportación están habilitados después de generar el reporte
        </div>
      </div>
    </div>

    <!-- Estado cuando no hay datos -->
    <div *ngIf="!generatingReport && (!reporteData?.total || reporteData.total === 0)" class="no-data-state">
      <div class="no-data-content">
        <span class="emoji">📊</span>
        <h4>No hay datos para mostrar</h4>
        <p>Seleccione los filtros y haga clic en "Generar Reporte" para ver los datos</p>
      </div>
    </div>
  </div>
</div>

  </main>
</div>

<!-- 📝 MODAL USUARIO -->
<div *ngIf="showUsuarioModal" class="modal-overlay" (click)="closeUsuarioModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingUsuario ? 'Editar Usuario' : 'Nuevo Usuario' }}</h3>
      <button (click)="closeUsuarioModal()" class="close-btn">✕</button>
    </div>

    <form [formGroup]="usuarioForm" (ngSubmit)="saveUsuario()">
      <div class="form-group">
        <label>Nombre completo</label>
        <input type="text" formControlName="nombre" placeholder="Juan Pérez">
      </div>

      <div class="form-group">
        <label>Email</label>
        <input type="email" formControlName="email" placeholder="usuario@email.com">
      </div>

      <div class="form-group">
        <label>{{ editingUsuario ? 'Nueva contraseña (opcional)' : 'Contraseña' }}</label>
        <input type="password" formControlName="password" placeholder="••••••">
      </div>

      <div class="form-group">
        <label>Teléfono</label>
        <input type="tel" formControlName="telefono" placeholder="+1234567890">
      </div>

      <div class="modal-actions">
        <button type="button" (click)="closeUsuarioModal()" class="secondary-btn">Cancelar</button>
        <button type="submit" [disabled]="usuarioForm.invalid || loading" class="primary-btn">
          {{ loading ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </form>
  </div>
</div>

<!-- 📝 MODAL MASCOTA -->
<div *ngIf="showMascotaModal" class="modal-overlay" (click)="closeMascotaModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>{{ editingMascota ? 'Editar Mascota' : 'Nueva Mascota' }}</h3>
      <button (click)="closeMascotaModal()" class="close-btn">✕</button>
    </div>

    <form [formGroup]="mascotaForm" (ngSubmit)="saveMascota()">
      <div class="form-group">
        <label>Nombre de la mascota</label>
        <input type="text" formControlName="nombre" placeholder="Firulais">
      </div>

      <div class="form-group">
        <label>Especie</label>
        <select formControlName="especie">
          <option value="">Seleccionar especie</option>
          <option value="Perro">Perro</option>
          <option value="Gato">Gato</option>
          <option value="Ave">Ave</option>
          <option value="Otro">Otro</option>
        </select>
      </div>

      <div class="form-group">
        <label>Raza</label>
        <input type="text" formControlName="raza" placeholder="Labrador">
      </div>

      <div class="form-group">
        <label>Edad (años)</label>
        <input type="number" formControlName="edad" min="0" max="30">
      </div>

      <div class="form-group">
        <label>Propietario (ID)</label>
        <input type="text" formControlName="propietario" placeholder="ID del usuario">
      </div>

      <div class="modal-actions">
        <button type="button" (click)="closeMascotaModal()" class="secondary-btn">Cancelar</button>
        <button type="submit" [disabled]="mascotaForm.invalid || loading" class="primary-btn">
          {{ loading ? 'Guardando...' : 'Guardar' }}
        </button>
      </div>
    </form>
  </div>
</div>
